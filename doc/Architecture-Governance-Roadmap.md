# Architecture & Governance Roadmap (Execution-Oriented)

> 更新日期：2026-02-26  
> 文档目标：把“架构/文件管理治理”从评估结论变成可执行任务，并支持双人并行协作。  
> 适用范围：仓库结构、模块边界、文档一致性、direct-write 门禁、计划治理规则。  
> 状态定义：`todo` / `in_progress` / `blocked` / `done` / `deferred`

---

## 1) 精华规则（提炼自 `doc/Roadmap.md`）

1. 任务 ID 冻结，不重排；新增任务只允许追加编号。  
2. 每个任务必须写清：来源、实现方式、DoD、依赖、回滚、负责人。  
3. 执行前先做分组评估：复杂度（S/M/L）+ 耦合度（low/medium/high）+ 风险（soft/hard）。  
4. `high coupling` 或 `hard risk` 任务必须串行；`low coupling + S/M` 可并行。  
5. 双人协同必须显式同步点，禁止隐式依赖。  
6. 计划文档只在 scope 变更时更新，不做逐任务快照同步；任务进度以 Roadmap 主文档为准。  
7. 每次交付必须执行文档联动排查，并写明“更新了哪些文档/为何不需要更新”。

---

## 2) 当前风险总览（按优先级）

### P0（阻塞级）

- `AG/P0-0` 计划文档更新规则与当前实践冲突（存在逐任务快照式更新）。  
- `AG/P0-1` `direct-write gate` 覆盖策略需收敛为状态域注册表驱动，避免新状态域漏检。  
- `AG/P0-2` workspace 包版本声明不一致（root=`0.5.0`，`cli/mcp-server` 仍声明 core `0.4.0`）。

### P1（高优先）

- `AG/P1-0` 计划命名体系分叉（Ha/Hb/Hc 与 H1/H2/H3 混用）。  
- `AG/P1-1` `packages/cli/src/index.ts` 单文件过大（8k+ 行），边界不清。  
- `AG/P1-2` Persona Package 结构在多个文档存在定义分叉。

### P2（优化级）

- `AG/P2-0` `packages/core/src` 单层文件过多（100+）。  
- `AG/P2-1` `packages/core/src/index.ts` 对外导出面过宽。  
- `AG/P2-2` 运行态/报告态资产治理策略需要收敛（降低仓库噪音）。

---

## 3) 执行策略与批次

### 3.1 分组评估（本轮）

| 分组 | 任务 | 复杂度 | 耦合 | 风险 | 策略 |
|---|---|---|---|---|---|
| AG0 | `AG/P0-0..3` | M | high | hard | 串行 |
| AG1 | `AG/P1-0..3` | M/L | medium | soft | 串行主 + 小并行 |
| AG2 | `AG/P2-0..3` | S/M | low | soft | 分组并行 |

### 3.2 双轨并行（无跨人依赖）

**原则**：A 与 B 各自一条链，链内严格按依赖顺序，链间无交叉依赖。两人可同时开工，互不阻塞。

| 批次 | Person A（代码/脚本/CLI） | Person B（文档/治理/配置） |
|------|---------------------------|----------------------------|
| 1 | AG/P0-1 direct-write 注册表 | AG/P0-0 计划文档规则 |
| 2 | AG/P0-3 架构治理 gate | AG/P1-2 Persona Package 单一真相源 |
| 3 | AG/P0-2 workspace 版本一致性 | AG/P1-3 计划命名体系 |
| 4 | AG/P1-0 CLI 入口模块化 | AG/P2-1 core 导出面收敛 |
| 5 | AG/P1-1 CLI 子命令拆分 | AG/P2-0 core 目录分层 |
| 6 | AG/P2-3 文档-代码一致性巡检 | AG/P2-2 运行态/报告态资产治理 |

**依赖链（仅链内）**  
- A：P0-1 → P0-3 → P0-2 → P1-0 → P1-1 → P2-3  
- B：P0-0 → P1-2 → P1-3 → P2-1 → P2-0 → P2-2（P2-1 完成后可并行 P2-0 与 P2-2）

**为消除跨人依赖所做的归属调整**：P0-2（workspace 版本）归 A，与 P0-1/P0-3 同属 verify 批次；P2-0（core 目录分层）归 B，在 P2-1 导出面收敛之后由 B 迁移目录，避免 A/B 交叉等待。

---

## 4) 任务清单（12项，A/B 可拆解）

### AG/P0-0 计划文档更新规则对齐

- 状态：`todo`
- 负责人：B（B 轨第 1 项）
- 来源：Roadmap 规则 1.3（计划文档只做 scope 变更）
- 实现方式：
  - 在 `doc/plans/` 文档模板中加入固定声明：进度以 Roadmap 主文档为准。
  - 清理现有计划文档中的“逐任务快照式状态更新”惯例，改为阶段性 scope 说明。
- DoD：
  - `doc/plans/*` 存量文档无与 Roadmap 冲突的更新规则描述。
  - 提交说明里列出受影响文件。
- 依赖：无
- 回滚：仅文档变更，回滚到上一版文本即可

### AG/P0-1 direct-write gate 收敛为状态域注册表

- 状态：`done`（2026-02-26）
- 负责人：A（A 轨第 1 项）
- 来源：E2 门禁与新增状态域扩展风险
- 实现方式：
  - 把 `scripts/check_direct_writes.mjs` 的硬编码状态文件列表提取成注册表（单一数据源）。
  - 校验“状态域 -> 允许写入模块”映射完整性。
- DoD：
  - 新增状态域时，只需修改注册表即可被 gate 检测。
  - 增加至少 2 个脚本级测试样例（漏配失败、正确通过）。
- 依赖：无（A 轨起点）
- 回滚：保留旧硬编码路径的兼容分支（临时开关）

### AG/P0-2 workspace 版本声明一致性

- 状态：`done`（2026-02-26）
- 负责人：A（A 轨第 3 项，verify 批次最后）
- 来源：包版本管理一致性
- 实现方式：
  - 统一 `packages/cli`、`packages/mcp-server` 对 `@soulseed/core` 的依赖声明策略。
  - 增加版本一致性检查脚本并接入 `verify.sh`。
- DoD：
  - 三个 workspace 包声明一致（避免 `0.4.0`/`0.5.0` 混用）。
  - 本地 `npm run verify` 通过。
- 依赖：`AG/P0-3`（A 轨 verify 批次顺序）
- 回滚：回退依赖声明与脚本变更

### AG/P0-3 架构治理 gate 接入 verify

- 状态：`done`（2026-02-26）
- 负责人：A（A 轨第 2 项）
- 来源：治理规则需要自动化门禁
- 实现方式：
  - 新增 `scripts/arch_governance_check.mjs`（检查关键规则：命名冲突、导出面、文档引用存在性）。
  - 接入 `scripts/verify.sh`。
- DoD：
  - 脚本能在违规时返回非 0 并输出结构化错误。
  - `verify.sh` 含该 gate 且通过。
- 依赖：`AG/P0-1`（A 轨 verify 批次顺序）
- 回滚：移除 gate + 恢复旧 verify 流程

### AG/P1-0 CLI 入口模块化（阶段1）

- 状态：`done`（2026-02-26）
- 负责人：A（A 轨第 4 项）
- 来源：`packages/cli/src/index.ts` 过大
- 实现方式：
  - 抽离命令路由与参数解析到 `commands/` 与 `parser/`。
  - 保持 CLI 对外行为不变。
- DoD：
  - 主入口文件行数显著下降。
  - 现有命令测试全部通过。
- 依赖：`AG/P0-2`（A 轨：gate 就绪后再动 CLI）
- 回滚：保留旧入口作为 fallback 分支

### AG/P1-1 CLI 子命令拆分（阶段2）

- 状态：`done`（2026-02-26）
- 负责人：A（A 轨第 5 项）
- 来源：命令逻辑耦合
- 实现方式：
  - 抽离 `persona`/`memory`/`chat` 子命令处理器。
  - 建立统一 `CommandHandler` 接口。
- DoD：
  - 子命令对应代码不再堆叠在单文件。
  - `packages/cli/test/*` 回归通过。
- 依赖：`AG/P1-0`
- 回滚：处理器聚合回主入口

### AG/P1-2 Persona Package 规范“单一真相源”

- 状态：`todo`
- 负责人：B（B 轨第 2 项）
- 来源：README / AGENT / Persona-Package-Layout 字段分叉
- 实现方式：
  - 指定 `doc/Persona-Package-Layout.md` 为唯一结构定义源。
  - 其他文档改为“引用 + 简述”，不再复制完整结构清单。
- DoD：
  - 三份核心文档无冲突字段定义。
  - 文档中明确“唯一真相源”说明。
- 依赖：`AG/P0-0`（B 轨：计划规则就绪后再统一文档）
- 回滚：恢复原段落内容

### AG/P1-3 计划命名体系归一（兼容映射）

- 状态：`todo`
- 负责人：B（B 轨第 3 项）
- 来源：Ha/Hb/Hc 与 H1/H2/H3 混用
- 实现方式：
  - 固定主命名体系（建议 Ha/Hb/Hc）。
  - 提供一次性映射表（旧名 -> 新名）并在文档顶部保留。
- DoD：
  - `doc/plans/` 命名与文档内自述一致。
  - Roadmap 引用路径无歧义。
- 依赖：`AG/P1-2`
- 回滚：保留双命名并延后收敛

### AG/P2-0 core 目录分层（低风险先行）

- 状态：`todo`
- 负责人：B（B 轨第 5 项，导出面冻结后再迁移目录）
- 来源：`packages/core/src` 扁平化过重
- 实现方式：
  - 按 domain 分层：`memory/`、`persona/`、`guards/`、`runtime/`、`governance/`。
  - 第一批仅迁移低耦合模块并保留导出兼容。
- DoD：
  - 迁移后 import 路径可工作，测试通过。
  - 无外部 API 破坏。
- 依赖：`AG/P2-1`（B 轨：先收敛导出面，再迁移目录）
- 回滚：按目录批次回退

### AG/P2-1 core 导出面收敛

- 状态：`todo`
- 负责人：B（B 轨第 4 项）
- 来源：barrel 导出过宽
- 实现方式：
  - 定义 `public` 导出白名单，内部模块不再默认导出。
  - 壳层仅依赖稳定 API。
- DoD：
  - `packages/core/src/index.ts` 不再无差别 `export *`。
  - 壳层编译通过，无 internal API 直连。
- 依赖：`AG/P1-2`
- 回滚：恢复现有导出面

### AG/P2-2 运行态/报告态资产治理

- 状态：`todo`
- 负责人：B（B 轨第 6 项，可与 P2-0 并行）
- 来源：仓库噪音与评审成本
- 实现方式：
  - 规范 `personas/`、`reports/` 的保留与归档策略。
  - 明确哪些产物仅本地留存，哪些可提交。
- DoD：
  - 新增治理说明文档并在 README 引用。
  - `.gitignore` 与策略一致。
- 依赖：`AG/P1-3`
- 回滚：回退策略文档与 ignore 变更

### AG/P2-3 文档-代码一致性巡检

- 状态：`todo`
- 负责人：A（A 轨第 6 项）
- 来源：长期一致性维护
- 实现方式：
  - 新增巡检脚本，校验关键字段/路径/命名在文档与代码中一致。
  - 接入 `verify.sh` 的非阻塞阶段，稳定后再提升为阻塞 gate。
- DoD：
  - 巡检报告可读且可定位。
  - 能正确识别至少 3 类不一致场景（命名、路径、字段）。
- 依赖：`AG/P1-1`（A 轨：CLI 稳定后再做巡检）
- 回滚：从 verify 中移除该检查

---

## 5) 双人协同分工（A/B，无跨人依赖）

### 5.1 任务归属与执行顺序

| 顺序 | Person A（代码/脚本/CLI） | Person B（文档/治理/配置） |
|------|---------------------------|----------------------------|
| 1 | AG/P0-1 direct-write 注册表 | AG/P0-0 计划文档规则 |
| 2 | AG/P0-3 架构治理 gate | AG/P1-2 Persona Package 单一真相源 |
| 3 | AG/P0-2 workspace 版本 | AG/P1-3 计划命名体系 |
| 4 | AG/P1-0 CLI 入口模块化 | AG/P2-1 core 导出面收敛 |
| 5 | AG/P1-1 CLI 子命令拆分 | AG/P2-0 core 目录分层 |
| 6 | AG/P2-3 文档-代码巡检 | AG/P2-2 运行态/报告态治理 |

**原则**：每人按自己轨道的 1→2→3→4→5→6 顺序执行，无需等待对方。B 轨第 5、6 项（P2-0、P2-2）在 P2-1 与 P1-3 完成后可并行。

**开工即有事做**：A 从 P0-1 起，B 从 P0-0 起；完成当前项即进入下一项，无空档。

### 5.2 同步点（已消除）

无跨人依赖，无需同步点。各自完成链内任务即可合并。

---

## 6) 验证与门禁

### 6.1 基础门禁

- `npm run verify`
- `npm run test`
- `npm run build`
- `npm run changelog:check`

### 6.2 本路线图新增门禁目标

1. direct-write 注册表完整性检查。  
2. workspace 版本声明一致性检查。  
3. 文档-代码一致性巡检（先非阻塞，后阻塞）。  
4. core 导出白名单检查。

---

## 7) 里程碑（建议）

A、B 双轨并行，无互相等待：

- W1：A 完成 P0-1/3/2，B 完成 P0-0、P1-2、P1-3（阻塞与文档真相清零）。  
- W2-W3：A 完成 P1-0/1，B 完成 P2-1（结构与导出面统一）。  
- W4：A 完成 P2-3，B 完成 P2-0、P2-2（维护性增强与自动巡检）。

---

## 8) 任务保全映射（防丢失）

本路线图所有任务采用追加策略，后续新增任务命名为：

- `AG/P0-4`...（阻塞级新增）
- `AG/P1-4`...（高优先新增）
- `AG/P2-4`...（优化级新增）

禁止重排、禁止复用已存在 ID。
