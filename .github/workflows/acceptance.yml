name: Acceptance

on:
  workflow_dispatch:
  schedule:
    - cron: "30 3 * * *"

concurrency:
  group: acceptance-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  acceptance:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Create .env from secrets
        if: ${{ secrets.DEEPSEEK_API_KEY != '' }}
        run: |
          cat > .env <<EOF
          DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}
          DEEPSEEK_BASE_URL=${{ secrets.DEEPSEEK_BASE_URL }}
          DEEPSEEK_MODEL=${{ secrets.DEEPSEEK_MODEL }}
          EOF

      - name: Run acceptance
        if: ${{ secrets.DEEPSEEK_API_KEY != '' }}
        run: npm run acceptance

      - name: Run MCP smoke
        if: ${{ secrets.DEEPSEEK_API_KEY != '' }}
        run: ./scripts/mcp_smoke.sh

      - name: Skip notice when secret missing
        if: ${{ secrets.DEEPSEEK_API_KEY == '' }}
        run: |
          mkdir -p reports/acceptance
          TS=$(date +%Y%m%d-%H%M%S)
          cat > "reports/acceptance/acceptance-skipped-${TS}.md" <<EOF
          # Acceptance Skipped

          - Reason: missing repository secret DEEPSEEK_API_KEY
          - Action: configure DEEPSEEK_API_KEY / DEEPSEEK_BASE_URL / DEEPSEEK_MODEL, then rerun workflow
          EOF

      - name: Quality scorecard (L0-L5 nightly)
        run: SOULSEED_QUALITY_SUITE=nightly node scripts/quality_scorecard.mjs
        continue-on-error: true

      - name: Nightly diff report
        run: node scripts/nightly_diff.mjs
        continue-on-error: true

      - name: Baseline delta check (nightly)
        run: node scripts/baseline_delta.mjs
        continue-on-error: false

      - name: Upload quality artifacts (nightly)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-nightly-${{ github.run_id }}
          path: |
            reports/quality/scorecard.json
            reports/quality/delta-report.md
            reports/quality/nightly-diff-*.md
          if-no-files-found: warn

      - name: Upload acceptance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: acceptance-reports-${{ github.run_id }}
          path: reports/acceptance/
          if-no-files-found: warn
